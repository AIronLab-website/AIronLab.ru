# üì§ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supabase Storage Buckets

> **–ó–∞–¥–∞—á–∞:** AIL-238 - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Storage buckets –∏ RLS policies

## –û–±–∑–æ—Ä

–°–æ–∑–¥–∞–¥–∏–º 3 Storage bucket –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

---

## –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Storage Buckets

### 1.1 –û—Ç–∫—Ä–æ–π—Ç–µ Storage –≤ Supabase

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à Supabase –ø—Ä–æ–µ–∫—Ç
2. –í –ª–µ–≤–æ–º –º–µ–Ω—é –Ω–∞–∂–º–∏—Ç–µ **Storage**
3. –ù–∞–∂–º–∏—Ç–µ **"Create a new bucket"**

---

### 1.2 –°–æ–∑–¥–∞—Ç—å bucket: `blog-images`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **Name** | `blog-images` |
| **Public bucket** | ‚úÖ Yes |
| **File size limit** | `5242880` (5MB) |
| **Allowed MIME types** | `image/jpeg`, `image/png`, `image/webp`, `image/gif` |

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±–ª–æ–≥–∞ (–æ–±–ª–æ–∂–∫–∏ —Å—Ç–∞—Ç–µ–π, –∞–≤–∞—Ç–∞—Ä—ã –∞–≤—Ç–æ—Ä–æ–≤, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ)

#### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∞–ø–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è bucket –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∞–ø–∫–∏ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:

```
blog-images/
‚îú‚îÄ‚îÄ featured/     # –û–±–ª–æ–∂–∫–∏ —Å—Ç–∞—Ç–µ–π
‚îú‚îÄ‚îÄ content/      # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
‚îî‚îÄ‚îÄ authors/      # –ê–≤–∞—Ç–∞—Ä—ã –∞–≤—Ç–æ—Ä–æ–≤
```

–ü–æ–¥–ø–∞–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤ —Å –ø—É—Ç—è–º–∏ —Ç–∏–ø–∞ `featured/image.jpg`.

---

### 1.3 –°–æ–∑–¥–∞—Ç—å bucket: `project-images`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **Name** | `project-images` |
| **Public bucket** | ‚úÖ Yes |
| **File size limit** | `5242880` (5MB) |
| **Allowed MIME types** | `image/jpeg`, `image/png`, `image/webp`, `image/gif` |

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤/–∫–µ–π—Å–æ–≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ

---

### 1.4 –°–æ–∑–¥–∞—Ç—å bucket: `temp-uploads`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **Name** | `temp-uploads` |
| **Public bucket** | ‚ùå No (Private) |
| **File size limit** | `10485760` (10MB) |
| **Allowed MIME types** | `image/*`, `video/*`, `application/pdf` |

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π)

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –≠—Ç–æ—Ç bucket –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–ø—Ä–∏–≤–∞—Ç–Ω—ã–º** (–Ω–µ –ø—É–±–ª–∏—á–Ω—ã–º)

---

## –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ RLS –∏ Storage Policies

### 2.1 –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é

1. –û—Ç–∫—Ä–æ–π—Ç–µ **SQL Editor** –≤ Supabase
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
   ```
   admin-panel/supabase/migrations/002_rls_and_storage_policies.sql
   ```
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
4. –ù–∞–∂–º–∏—Ç–µ **"Run"** (–∏–ª–∏ `Ctrl+Enter`)

### 2.2 –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

‚úÖ –í–∫–ª—é—á–∞–µ—Ç RLS –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö  
‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–µ read-only –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è published –∫–æ–Ω—Ç–µ–Ω—Ç–∞  
‚úÖ –°–æ–∑–¥–∞–µ—Ç admin full-access –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
‚úÖ –°–æ–∑–¥–∞–µ—Ç Storage policies –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤

---

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö buckets

### 3.1 –ß–µ—Ä–µ–∑ UI

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Storage** ‚Üí **Buckets**
2. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
   - ‚úÖ `blog-images` (Public)
   - ‚úÖ `project-images` (Public)
   - ‚úÖ `temp-uploads` (Private)

### 3.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ Policies

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Storage** ‚Üí **Policies**
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ bucket –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã policies:
   - **Select** (Public –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö buckets)
   - **Insert** (Admin only)
   - **Update** (Admin only)
   - **Delete** (Admin only)

---

## –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Storage

### 4.1 –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Storage** ‚Üí `blog-images`
2. –ù–∞–∂–º–∏—Ç–µ **"Upload file"**
3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `test-image.jpg`)
4. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–∞–π–ª
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Public URL**

### 4.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

–û—Ç–∫—Ä–æ–π—Ç–µ Public URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è.

**–§–æ—Ä–º–∞—Ç URL:**
```
https://your-project-id.supabase.co/storage/v1/object/public/blog-images/test-image.jpg
```

---

## –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS Policies

### 5.1 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å RLS

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª—é—á–µ–Ω –ª–∏ RLS
SELECT 
  schemaname,
  tablename,
  rowsecurity as rls_enabled
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename IN (
    'blog_authors', 
    'blog_categories', 
    'blog_tags', 
    'blog_posts', 
    'blog_post_tags', 
    'projects'
  )
ORDER BY tablename;
```

–í—Å–µ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å `rls_enabled = true`.

### 5.2 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ policies

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ policies
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 policy –Ω–∞ –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É:
- Public read (–¥–ª—è SELECT)
- Admin full access (–¥–ª—è ALL)

---

## –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –≤—ã –±—É–¥–µ—Ç–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã —Å frontend, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings** ‚Üí **API**
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–æ **CORS**
3. –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ –¥–æ–º–µ–Ω—ã:
   ```
   http://localhost:3000
   https://aironlab.ru
   https://www.aironlab.ru
   ```

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å:

- ‚úÖ 3 Storage buckets –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ RLS –≤–∫–ª—é—á–µ–Ω –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–µ read-only policies –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- ‚úÖ Admin full-access policies –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
- ‚úÖ Storage policies –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

---

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ [–í—ã–ø–æ–ª–Ω–µ–Ω–æ] AIL-237: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î
2. ‚úÖ [–í—ã–ø–æ–ª–Ω–µ–Ω–æ] AIL-238: Storage –∏ RLS
3. ‚è≠Ô∏è AIL-239: –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ TypeScript types

---

## üÜò Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Storage policies –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ buckets —Å–æ–∑–¥–∞–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ RLS –≤–∫–ª—é—á–µ–Ω: `ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;`
3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ policies, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ –º–æ–≥—É –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —á–µ—Ä–µ–∑ frontend

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Supabase client
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç MIME —Ç–∏–ø–∞–º –∏ —Ä–∞–∑–º–µ—Ä—É

### –ü—Ä–æ–±–ª–µ–º–∞: Public URL –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ bucket —Å–æ–∑–¥–∞–Ω –∫–∞–∫ **Public**
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Storage policy –¥–ª—è SELECT
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å bucket

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Supabase Storage Documentation](https://supabase.com/docs/guides/storage)
- [Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Storage Policies](https://supabase.com/docs/guides/storage/security/access-control)

